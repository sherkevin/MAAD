## 每日进展日志（2025-08-14）

### 今日完成
- 建立 conda 环境 `tsad310`（Python 3.10.18）。
- 安装 PyTorch/vision/audio、timm、lightning、torchmetrics、matplotlib、opencv-python、kornia/imgaug/einops、jsonargparse 等依赖。
- 安装内嵌 `anomalib`，并在 loggers 与 image models 入口处做“可选依赖”保护以避免 heavy extras 阻塞。
- 新增脚本 `sound-anomaly-main/scripts/make_fake_msl.py` 生成假数据；成功运行 1 epoch（MPS 上）。
- 修复 `data_factory/dataloader.py` 中 KPI/YAHOO 的 `lamda` 未定义问题；
- 新增 `project_logs/DRAFT.md`（论文初稿大纲，含摘要/方法/实验/系统部分）。

### 运行要点
- 命令：
```
conda activate tsad310
python sound-anomaly-main/scripts/make_fake_msl.py
cd sound-anomaly-main
python main.py experiment.root="/Users/ginger/Downloads/codding way/sound-anomaly-main/outputs/fake_data" trainer.max_epochs=1
```
- 训练成功；timm 自动下载 resnet18 预训练；日志表格打印成功（本轮指标表为空行）。

### 遇到问题与修复
- av/comet/wandb 等重依赖导致导入失败 → 将 logger 与非必要模型改为 try-import。
- numpy 2.x 与 imgaug 兼容性 → 将 numpy 降级为 1.26.4。
- 缺失 matplotlib/opencv/kornia → 分步安装。

### 明日计划
- 修复 `data_factory/dataloader.py` 的 KPI/YAHOO `lamda` 未定义；
- 加入 `FusionGate(mlp)` 与 Hydra 开关，完成 DGPA 的第一步（不含 LLM）；
- 解析并对齐基线表 `/Users/ginger/Downloads/codding way/VOROUS Results Collection.xlsx`；
- 阅读并摘录你上传的两篇论文要点，形成方法对照与故事线要点清单。
- 在 DGPA 中实现 `FusionGate(mlp)` 与 `fusion` 开关（train_free=false），并给出最小消融脚本；
- 接入 Qwen 的占位与缓存接口（不阻塞，先返回规则权重），准备蒸馏流程草案；

### 备注
- LLM 建议使用 Qwen，本地 transformers 推理；先实现 `mlp` 版，随后加 `llm_cached/hybrid`。

### 论文阅读摘记（today）
- Nature 硬件光学/复数卷积加速器（s41467-024-55321-8）：
  - 关注点：以硬件为中心的“性能与可扩展性”叙事，强调真实系统吞吐（>2 TOPS）与相位信息处理优势；
  - 启发：我们的“工程可部署 + 稳定可靠”主线需要同样的叙事风格——报告延迟、显存、在线更新代价，给出稳定性指标与可解释图；尽管不涉及硬件，也要在“系统层面”讲清楚效率与鲁棒性。
- VISTA（ACM MM）：
  - 关注点：分解（LOESS）+ 多变量稳健表示 + 免训练；
  - 启发：与我们“STL分解+PatchCore”的路线高度契合；DGPA 可视作“训练可选”的自适应融合层；配合 DACM（在线记忆更新）提升多域鲁棒；PICC 的校准与延迟指标补足“免训练方法”常缺的可靠性评估。

### 计划微调
- DGPA：优先做 `mlp` + `llm_cached`，并提供“训练可选”开关（纯零训练→近似 VISTA；轻量训练→增强版）。
- DACM：增强日志，重点报告“更新触发率-收益曲线”。
- PICC：在主结果表中加入稳定性与延迟列，突出“系统级可靠性”。

### 对话记录条目（追加）
- 进展确认：
  - 已完成 DGPA 的 rule 与 mlp 两种门控；在 `voraus` 转换子集上 1 epoch 通过。
  - 新增 `scripts/convert_voraus_to_npy.py` 并完成转换与试跑；
  - 读取并合并 VOROUS 基线 Excel，导出 `outputs/vorous_baseline_summary.csv`；
  - 后续每次对话均将追加到当天日志，确保完备记录。
- 下一步：实现 PICC 的物理先验正则（趋势/季节平滑，残差频域约束），并做最小消融（rule vs mlp，有/无物理约束）。

### 网络/中断记录
- 今日出现一次网络中断，已恢复；后续流程不受影响。将持续在日志中记录此类中断以便回溯。

### 阶段性小结（当日归档）
- 代码/框架：
  - DGPA 门控：完成 rule 与 mlp；预留 llm/hybrid，并新增 `anomalibv2/src/anomalib/utils/llm.py`（Qwen 接口占位）。
  - PICC 物理先验：新增趋势/季节平滑与残差高通（`physics_enable/kernel`），指标侧增加固定 FPR 下的 F1 与阈值。
  - DACM：在 `DAPatchcore.fit()` 增加窗口化记忆更新钩子（`drift_enable/windows`）。
  - 数据：新增 `convert_voraus_to_npy.py` 将 `/voraus` CSV 转为 MSL 结构；`inject_synthetic_labels.py` 注入3%合成标签；`parse_vorous_baseline.py` 解析基线 Excel。
  - 文档：完善 README（VOROUS 使用、网络提示）；撰写 `PLAN.md`、`DRAFT.md` 并多次更新今日日志。

- 实验（VOROUS 转换子集，3%合成阳性，1 epoch，快速烟雾）：
  - fusion=mlp, physics=开：
    - AUROC=0.4795, AUPR=0.8506, F1Max=0.9224, F1@FPR1/5/10%=0.0245/0.1053/0.1326
  - fusion=rule, physics=关：
    - AUROC=0.4996, AUPR=0.8543, F1Max=0.9224, F1@FPR1/5/10%=0.0185/0.0941/0.1053
  - fusion=mlp, physics=关：
    - AUROC=0.5521, AUPR=0.8730, F1Max=0.9224, F1@FPR1/5/10%=0.0245/0.1433/0.2653
  - fusion=rule, physics=开：
    - AUROC=0.4996, AUPR=0.8543, F1Max=0.9224, F1@FPR1/5/10%=0.0123/0.0885/0.1053

- 观察：
  - 极不均衡（3%阳性）下，F1Max 与 AUPR 高而 AUROC 偏低属常见；
  - 当前以部署友好的低FPR衡量，mlp+physics=关 配置较优；后续结合校准与DACM预计可提升低FPR性能与阈值稳定性。

- 进度（粗评）：
  - DGPA：rule/mlp 完成，llm 占位（30%→60%）
  - DACM：基础钩子就绪（0%→30%）
  - PICC：先验/指标部分完成（20%→40%）
  - 基线解析与文档：完成当日目标

- 明日计划：
  - 接入简化的频域白噪声正则与分位数/Conformal 校准；
  - 完成 DACM 流水线与触发率-收益曲线记录；
  - 跑公开带标签数据集（MSL/SMAP/PSM/…）标准指标，对齐对比表。

### 论文启发补充（傅里叶与复值表示）
- 线性组合：FFT 线性性 → 频域逐通道加权叠加，保持相位信息；
- 复值系数：统一用 \(e^{j\theta}=\cos\theta+j\sin\theta\) 表达，幅度/相位解耦，数值更稳；
- 非线性项：用卷积定理在频域实现（轻量附加分支），与主干融合前做幅度归一；
- 并行与正交：参考“多波长/正交通道”思想，确保实/虚部处理正交；
- 校准：频域分支输出与时域主干统一归一后执行分位数/Conformal 校准，提升低 FPR 可用性。



### 追加实验（VORAUS→MSL 兼容数据，含 2% 合成标签，1 epoch，MPS）

- 指标判读简则：
  - AUROC 接近 1 越好；0.5≈随机。
  - AUPR 越高越好，需高于阳性基线（此处阳性≈2%）。
  - F1Max 越高越好；但更看重 F1@FPR1%、5%、10%（低误报能力）。

- 对比结果（同一数据与标签）：

| DGPA | Physics | DACM windows | AUROC | AUPR | F1Max | F1@FPR1% | F1@FPR5% | F1@FPR10% |
|---|---|---:|---:|---:|---:|---:|---:|---:|
| rule | off | 1 | 0.5028 | 0.7087 | 0.8336 | 0.0220 | 0.0429 | 0.1224 |
| mlp | off | 1 | 0.4894 | 0.7095 | 0.8336 | 0.0364 | 0.0358 | 0.1275 |
| mlp | on | 1 | 0.4809 | 0.7102 | 0.8336 | 0.0364 | 0.0358 | 0.0900 |
| hybrid | off | 1 | 0.4963 | 0.7191 | 0.8344 | 0.0576 | 0.1038 | 0.1942 |
| hybrid | on | 1 | 0.4986 | 0.7058 | 0.8336 | 0.0220 | 0.0429 | 0.1338 |
| mlp | off | 4 | 0.4894 | 0.7095 | 0.8336 | 0.0364 | 0.0358 | 0.1275 |

- 观察与结论：
  - 低 FPR 表现最佳的是 hybrid + physics=off（1%、5%、10% 均领先），说明 DGPA 的混合门控在此数据上有效。
  - physics=on 在随机点异常的合成标签下无益，甚至略降；更适合结构化异动与真实频域先验。
  - 简单 DACM（仅分块采样）未见显著收益；需要加入 KS/PSI 漂移检测与“按需更新”策略。

- 下一步（与论文三大创新对齐）：
  1) DGPA：保留 hybrid 为默认；实现 LLM 权重→缓存/蒸馏，形成训练可选版本。
  2) PICC：加入频域白噪声正则与分位/共形校准，主攻 F1@FPR1%、5% 的稳定提升与阈值可解释。
  3) DACM：接入 KS/PSI 漂移检测与触发-收益曲线记录，只在漂移时更新记忆。
  4) 切换真实带标签数据（MSL/SMAP/PSM），并在服务器上使用 `pre_trained=true` 完整评测。

### Round-2 计划（引入 PINN 启发）
- DGPA：新增 `fusion_act ∈ {sine, gelu, relu}` 与可选 Fourier features；默认 `sine/fourier+gelu`。
- PICC：课程式 λ_physics 调度（每 N 步×1.5）+ GradNorm 多损平衡；频域白噪正则 + 分位/Conformal 校准；新增阈值稳定性指标。
- DACM（PRAC）：残差加权的自适应记忆采样 + 分层覆盖；KS/PSI 漂移触发 + 触发-收益曲线。
- 实验策略：
  - Best 基线：hybrid + physics=off + DACM(w=4)（已定）
  - 放大窗口：w=8（本地快速检验）→ 服务器全量（pre_trained=true）
  - 观察项：F1@FPR 1/5/10%，阈值稳定性，触发-收益曲线

### 本地烟雾测试（真实带标签 MSL，全量文件，1 epoch）
- 配置：root=`/Users/ginger/Downloads/codding way/data`，dataset=MSL，DGPA=hybrid，physics=off，DACM=on(w=4)，pre_trained=false（Mac网络避免下载权重），epoch=1。
- 结果：
  - AUROC=0.749790，AUPR=0.274082，F1Max=0.386404
  - F1@FPR1%=0.058140，F1@FPR5%=0.143498，F1@FPR10%=0.251701
- 结论：流程与指标计算完整可用；本地无预训练权重情况下取得合理基线，后续在服务器启用 `pre_trained=true` 与 PICC/DACM-PRAC/激活-频域增强后再做主结果表。

### 追加对照（MSL，1 epoch，pre_trained=false）
- mlp/off, DACM on(w=4): AUROC=0.759841, AUPR=0.333164, F1@FPR1/5/10%=0.035/0.317/0.347
- hybrid/on, DACM on(w=4): AUROC=0.755910, AUPR=0.272640, F1@FPR1/5/10%=0.069/0.118/0.252
- hybrid/off, DACM on(w=8): AUROC=0.750181, AUPR=0.274197, F1@FPR1/5/10%=0.058/0.143/0.252
- mlp/off, DACM on(w=8): AUROC=0.759841, AUPR=0.332942, F1@FPR1/5/10%=0.035/0.317/0.347
- mlp/off, DACM off: AUROC=0.759873, AUPR=0.333175, F1@FPR1/5/10%=0.035/0.317/0.347
- hybrid/off, DACM off: AUROC=0.749714, AUPR=0.274142, F1@FPR1/5/10%=0.058/0.143/0.252

小结：
- DGPA=mlp/off 最稳（AUROC/AUPR/低FPR表现最佳）；hybrid 在 1% FPR 偶有小幅优势，整体不如 mlp/off。
- DACM w=4 vs w=8、开/关对当前结果影响极小，需引入漂移检测+PRAC 残差加权。
- physics=on 在本地1 epoch与无预训练下未显益，待服务器+PICC校准验证。
